importScripts("lib/underscore.js");var facade=function(){function n(n){throw new Error(n)}function r(n){return"undefined"!=typeof n&&null!==n}function t(n){e(n,["cmd","id"])}function e(r,t){_.every(t,function(t){return _.has(r,t)||n("No '"+t+"' key provided.")})}function u(n,r){return r&&(M[n].currentData=r),M[n].currentData}function i(n){return M[n].originalData}function a(n,r){return M[n].meta[r].type}function o(t,e){r(M[t])||n("No table under '"+t+"' key.");var u=_.find(i(t),function(n){return c(n)==e});return r(u)||n("No table row in table with '"+t+"' id under '"+e+"' id."),u}function c(n){return n.id}function d(n){return n.data}function f(n,r){return n.data[r]}function s(n,t,e,u){var i=M[n].filters;return u?r(i[t][e].value[u])?i[t][e].value[u]:void 0:i[t][e].value}function l(n){return _.indexOf(["numeric","integer"],n)>-1}function m(n){return n===v()}function v(){return"__custom"}function p(n,t,e){return m(t)?function(r){var u=s(n,t,e);return!!_.isArray(u)&&u.indexOf(r)===-1}:l(e)?function(u){var i=parseFloat(b(u)),a=parseFloat(s(n,t,e,"min")),o=parseFloat(s(n,t,e,"max")),c=!1;return c=!(!r(a)||isNaN(a))&&i<a,c||!(!r(o)||isNaN(o))&&i>o}:function(u){var i=String(u).toLowerCase(),a=s(n,t,e);return r(a)&&i.indexOf(String(a).toLowerCase())===-1}}function h(t,e,u,i){var a=M[t].filters;return!!r(a[u])&&(m(u)?(!r(i)&&n("Custom filter should be provided with type over which to check values."),a[u][i].comparator(e)):_.some(a[u],function(n){return n.comparator(e)}))}function y(n,r){var t=_.partial(h,n);return t(c(r),v(),"id")||_.some(d(r),t)}function k(n,t,e,u,i){var a=M[n].filters;r(a[e])||(a[e]={}),r(a[e][u])||(a[e][u]={comparator:p(n,e,u),value:null}),i?(_.isObject(a[e][u].value)||(a[e][u].value={}),a[e][u].value[i]=t):a[e][u].value=t}function I(n){var r=_.filter(i(n),function(r){return!y(n,r)});u(n,r)}function w(n,r,t,e,u){k(n,r,t,e,u),I(n)}function g(n,r){k(n,r,v(),"id"),I(n)}function N(n,r){return r&&(M[n].perChunk=r),M[n].perChunk}function b(n){return"Inf"===n?Number.MAX_VALUE:"-Inf"===n?-Number.MAX_VALUE:n}function x(n){var r,t;return r=/<a[^>]*>(.*?)<\/a>/,t=_.isFunction(n.match)&&n.match(r),_.isArray(t)&&_.size(t)>1?t[1]:n}function A(n,r){var t,e=function(n,r){var t=[],e=0;return _.each(u(n),function(n){var u=f(n,r);"NA"==u?e++:t.push(parseFloat(b(u)))}),{summary:t,summaryNA:e}},i=function(n,r){var t=[];return _.each(u(n),function(n){var e,u=f(n,r);e=_.find(t,function(n){return n.value==u}),e?e.count++:t.push({value:u,count:1})}),t},o=function(n){return n.summary.sort(function(n,r){return n>r?1:n<r?-1:0}),n},c=function(n){return n.sort(function(n,r){return n.count>r.count?-1:n.count<r.count?1:0})},d=function(n){var r=0,t=Math.floor(n.summary.length/2);r=n.summary.length%2?n.summary[t]:(n.summary[t-1]+n.summary[t])/2;var e=_.reduce(n.summary,function(n,r){return n+(isNaN(r)?0:r)},0);return{"Min.":n.summary[0],Median:r.toFixed(3),Mean:(e/n.summary.length).toFixed(3),"Max.":_.last(n.summary),NA:n.summaryNA}},s=function(n){for(var r={},t=0,e=n.length<6?n.length:6;t<e;t++)r[n[t].value]=n[t].count;return n.length>6&&(r["(Other)"]=n.length-6),r},l=function(n,r,t){return"numeric"==t&&d(o(e(n,r)))},m=function(n,r){return s(c(i(n,r)))};return _.some([l,m],function(e){return t=e(n,r,a(n,r))}),t}function C(n,r,t){t=N(n,t);var e=r*t,i=0;return _.filter(u(n),function(n,r){return r>=e&&i++<t})}function F(n){return _.map(u(n),function(n){return c(n)})}function j(n,r,t){function e(n,e){var u=n.data[r],i=e.data[r];u=x(u),i=x(i),u=b(u),i=b(i);var a=!isNaN(parseFloat(u))&&parseFloat(u)==u;return a&&(u=parseFloat(u),i=parseFloat(i)),"asc"===t?u<i?-1:u>i?1:0:u<i?1:u>i?-1:0}u(n).sort(e),i(n).sort(e)}var M={};return{init:function(n){function r(n){return _.map(n,function(n,r){return{id:r,data:_.map(n,_.identity)}})}function u(n){return _.map(n,_.identity)}t(n),e(n,["meta","data","perChunk"]);var i=_.extend(_.pick(n,["meta","perChunk"]),{summaryCache:{},filters:{}});return i.meta=u(i.meta),i.originalData=r(n.data),i.currentData=_.clone(i.originalData),M[n.id]=i,n},getDataChunk:function(n){t(n),e(n,["chunkNo","perChunk"]);var r=_.clone(n);return r.chunk=C(n.id,n.chunkNo,n.perChunk),_.pick(r,["id","cmd","chunk","jobId"])},terminate:function(n){return t(n),delete M[n.id],_.pick(n,["id","cmd"])},sort:function(n){t(n),e(n,["colIdx","order"]);var r=_.clone(n);return j(n.id,n.colIdx,n.order),r.chunk=C(n.id,0,N(n.id)),_.pick(r,["id","cmd","chunk","jobId"])},filter:function(n){t(n),e(n,["colIdx","type","subtype","value"]);var r=_.clone(n);return w.apply(self,_.values(_.pick(n,["id","value","colIdx","type","subtype"]))),_.extend(r,{chunk:C(n.id,0,N(n.id)),rowIds:F(n.id)}),_.pick(r,["id","cmd","chunk","rowIds","jobId"])},filterByIds:function(n){t(n),e(n,["rowIds"]);var r=_.clone(n);return g.apply(self,_.values(_.pick(n,["id","rowIds"]))),_.extend(r,{chunk:C(n.id,0,N(n.id)),rowIds:F(n.id)}),_.pick(r,["id","cmd","chunk","rowIds","jobId"])},getActiveRows:function(n){t(n);var r=_.clone(n);return r.rows=u(n.id),_.pick(r,["id","cmd","jobId","rows"])},getRow:function(n){t(n);var r=_.clone(n);return r.row=o(n.id,n.rowId),_.pick(r,["id","cmd","jobId","row"])},getSummary:function(n){t(n),e(n,["id","colIdx"]);var r=_.clone(n);return r.summary=A.apply(self,_.values(_.pick(n,["id","colIdx"]))),_.pick(r,["id","cmd","jobId","summary"])}}}();self.addEventListener("message",function(n){self.postMessage(facade[n.data.cmd](n.data))},!1);